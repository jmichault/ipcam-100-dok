

# IMP (Ingenic Media Platform) (انظر عفريت_system.h)

## مفاهيم أساسية
تعتمد برمجة T20 / T21 على المفاهيم التالية:
1. الطرفية (= الجهاز)  
    يكمل الجهاز الطرفي وظيفة. أمثلة:
     *  مصدر الإطار: ينهي إخراج بيانات الفيديو.
     *  التشفير: يكمل تشفير الفيديو أو وظيفة ترميز الصورة.
2. المجموعة  
    المجموعة هي أصغر وحدة إدخال بيانات. يمكن أن يحتوي الجهاز على عدة مجموعات ويمكن لكل مجموعة استقبال قناة إدخال بيانات واحدة فقط. يمكن أن يكون للمجموعة عدة نتائج.  
    المجموعة أيضًا عبارة عن حاوية لوظائف محددة "". انظر الشرح في قسم القناة لمزيد من التفاصيل.
3. خروج  
    الإخراج هو أصغر وحدة من إخراج البيانات لكل مجموعة. يمكن أن يكون للمجموعة عدة مخرجات ويمكن أن ينتج كل ناتج قناة بيانات واحدة فقط.
4. خلية  
    تشير الخلية إلى مجموعة تحتوي على معلومات حول الجهاز والمجموعة والمخرجات. يتم تقديمه في بنية بيانات IMPCell.
تُستخدم الخلية بشكل أساسي لربط (@ ref bind). وفقًا لتعريف الجهاز والمجموعة والإخراج ، فإن الإخراج هو عقدة إخراج البيانات والمجموعة هي عقدة إدخال البيانات.
في Bind ، يكون فهرس الخلية لعقدة إخراج البيانات عند إخراج الإخراج ، ويكون فهرس الخلية لعقدة إدخال البيانات في مجموعة الإدخال (بحيث تكون الخلية ، وإدخال بيانات الإخراج هو قيمة غير منطقية).
5. القناة  
    تشير القناة بشكل عام إلى وحدة ذات وظيفة واحدة. تستقبل القناة وظيفة محددة عند إنشائها (إنشاء مثيل).  
    على سبيل المثال:  
     -  بالنسبة لجهاز التشفير ، تكمل إحدى القنوات كود H264 أو وظيفة تشفير JPEG. يتم تحديد نوع وظيفة الترميز المحددة (، المعلمة) عند إنشاء القناة


     -  بالنسبة إلى IVS ، تكمل القناة وظيفة خوارزمية محددة ويتم تحديد معلمات نوع خوارزمية محددة عند إنشاء القناة


     -  بالنسبة إلى OSD ، توجد منطقة مشابهة للقناة ، والمنطقة عبارة عن منطقة تراكب محددة ، والتي يمكن أن تكون صورة PIC ()، وإغلاق الغطاء ()، وما إلى ذلك. .


     -  بالنسبة لـ FrameSource ، تُنتج القناة صورة أصلية وتكون قناة FrameSource في الواقع مجموعة


     
     يجب أن تكون القناة ، كوحدة وظيفية ، مسجلة بشكل عام في المجموعة (بالإضافة إلى FrameSource) لتلقي البيانات. بعد تسجيل القناة في المجموعة ، ستتلقى البيانات التي أدخلتها المجموعة.

    يختلف أيضًا عدد القنوات التي يمكن تسجيلها بواسطة مجموعة الأجهزة المختلفة.

## وحدات الربط (ربط)

بمجرد توصيل مجموعتين بواسطة Bind ، سيتم إرسال البيانات من مجموعة المصدر تلقائيًا إلى المجموعة الوجهة.  
نظرًا لأن المجموعة هي أصغر وحدة إدخال بيانات والمخرج هو أصغر وحدة إخراج بيانات ، فإن معرف الجهاز ومعرف المجموعة ومعرف الإخراج الخاص بـ srcCell في كلا معلمات IMP_System_Bind (IMPCell * srcCell ، IMPCell * dstCell) صالحة.  

بينما يكون dstCell صالحًا فقط لمعرّف الجهاز ومعرّف المجموعة ، فإن معرّف الإخراج لا يكون له معنى كإدخال بيانات.

مثال 1: 
```
IMPCell fs_chn0 = {DEV_ID_FS, 0, 0};    // FrameSource deviceID: DEV_ID_FS groupID: 0 outputID: 0
IMPCell enc_grp0 = {DEV_ID_ENC, 0, 0}; // ENC deviceID: DEV_ID_ENC groupID : 0 outputID: 0, où le troisième paramètre de enc_grp0 n'a pas de sens. 
int ret = IMP_System_Bind (& fs_chn0, & enc_grp0);
if(ret <0>)
  printf ("Bind FrameSource Channel0 and Encoder Group0 failed \ n");

```

* يتم إنشاء مجموعة تنشئ ارتباطًا من FrameSource إلى Encoder.


* يتم تسجيل قناتين في Encoder Group ، لذا فإن Encoder Group لها مخرجان H264 و JPEG.



المثال 2:
```
// flux de données principal
IMPCell fs_chn0 = {DEV_ID_FS, 0, 0};
IMPCell osd_grp0 = {DEV_ID_OSD, 0, 0};
IMPCell enc_grp0 = {DEV_ID_ENC, 0, 0};
int ret = IMP_System_Bind(&fs_chn0, &osd_grp0);
if (ret < 0)
    printf("Bind FrameSource Channel0 and OSD Group0 failed\n");

int ret = IMP_System_Bind(&osd_grp0, &enc_grp0);
if (ret < 0)
    printf("Bind OSD Group0 and Encoder Group0 failed\n");

// flux de données lié 
IMPCell fs_chn1_output0 = {DEV_ID_FS, 1, 0};
IMPCell ivs_grp0 = {DEV_ID_IVS, 0, 0};
IMPCell osd_grp1 = {DEV_ID_OSD, 1, 0};
IMPCell enc_grp1 = {DEV_ID_ENC, 1, 0};

int ret = IMP_System_Bind(&fs_chn1_output0, &ivs_grp0);
if (ret < 0)
    printf("Bind FrameSource Channel1 and IVS Group0 failed\n");

int ret = IMP_System_Bind(&ivs_grp0, &osd_grp1);
if (ret < 0)
    printf("Bind IVS Group0 and OSD Group1 failed\n");

int ret = IMP_System_Bind(&osd_grp1, &enc_grp1);
if (ret < 0)
    printf("Bind OSD Group1 and Encoder Group1 failed\n");
```
هذا برنامج Bind نموذجي: دفق شفرة ثنائي القناة.
 * يحتوي مصدر الإطار على ناتجين ، وهما التدفق الرئيسي Channel0 (1280x720) وقناة تيار الرقيق 1 (640x360).
   *   الدفق الرئيسي: قناة FrameSource 0 ربط OSD Group.0 ، OSD Group.0 Bind Encoder Group.0. من بينها: 
       * OSD Group.0 سجلت منطقتين تستخدمان لعرض معلومات الطابع الزمني والسلسلة على التوالي
       * مجموعة التشفير .0 سجلت قناتين. ، وهو ترميز H264 وترميز JPEG على التوالي. من بينها ، إذا كان حجم الصورة لقناة تشفير JPEG لا يتطابق مع معلمة الإدخال (لقناة FrameSource0)، فسيتم تحجيمها (البرنامج عند T10) ) تحقيق هدف الالتقاط بأي دقة. (° 18 درجة)
       
ملاحظات:
* يوصى بإجراء جميع عمليات الارتباط أثناء تهيئة النظام.
* لا يمكن استدعاء عمليات الربط وإلغاء الربط ديناميكيًا بعد تنشيط _FrameSource_ . يتم إلغاء الربط فقط بعد التعطيل _FrameSource_.

## المهام

### int IMP\_النظام\_البداية (فارغة )
تهيئة نظام IMP.
تعيد 0 إذا نجحت.
بعد استدعاء API هذا ، سيتم تهيئة بنية البيانات الأساسية ، لكن لن تتم تهيئة الجهاز.
تنبيه: يجب استدعاء هذه الوظيفة للبدء قبل أي عملية أخرى.
### int IMP_System_خروج (فارغ)

بعد استدعاء هذه الوظيفة ، سيتم تحرير كل الذاكرة و IMP _handles_ ، وسيتم إيقاف تشغيل الجهاز. 
ملاحظة: بعد استدعاء واجهة برمجة التطبيقات هذه ، إذا كنت تريد استخدام بروتوكول IMP مرة أخرى ، فأنت بحاجة إلى إعادة ضبط نظام IMP.

### int64_t IMP_النظام_GetTimeStamp (void)

احصل على الطابع الزمني لنظام IMP بالميكروثانية.  
العودة: الوقت بالميكروثانية.

### Int IMP_System_RebaseTimeStamp (قواعد int64_t)
اضبط الطابع الزمني لنظام IMP بالميكروثانية.  
العودة: 0 إذا نجحت.

### uint32_t IMP_النظام_ReadReg32 (uint32_t u32Addr)

اقرأ قيمة التسجيل 32 بت.  

### فارغ IMP_System_WriteReg32 (uint32_t regAddr, valeur uint32_t)
اكتب القيمة في سجل 32 بت.

ملاحظة: يرجى الاتصال بواجهة برمجة التطبيقات هذه بعناية والتحقق من معنى السجل ، وإلا فقد يتسبب ذلك في حدوث أخطاء في النظام.

### int IMP_System_GetVersion (IMPVersion * pstVersion) 

احصل على رقم إصدار نظام IMP.

### حرف ثابت * IMP_System_GetCPUInfo (فارغ)
احصل على معلومات حول طراز وحدة المعالجة المركزية.  
ملاحظة: القيمة المرجعة هي سلسلة من طراز وحدة المعالجة المركزية ، على سبيل المثال ، بالنسبة إلى T10 ، هناك "T10"و "T10-Lite".

### int IMP_System_ربط (IMPCell * srcCell ، IMPCell * dstCell)

ربط بين خلية المصدر والوجهة.

ملاحظة 1: وفقًا لمفاهيم الجهاز والمجموعة والإخراج ، يمكن أن يكون لكل جهاز عدة مجموعات ، ويمكن أن يكون لكل مجموعة عدة مخرجات ، ويتم استخدام المجموعة كواجهة إدخال للجهاز ، ويتم استخدام الإخراج كواجهة منتج للجهاز. لذلك ، يقوم الارتباط فعليًا بتوصيل إخراج معين لجهاز الإخراج بمجموعة معينة من جهاز الإدخال.

ملاحظة 2: بعد ارتباط ناجح ، سيتم إرسال البيانات التي تم إنشاؤها بواسطة إخراج srcCell () تلقائيًا إلى الخلية الوجهة (المجموعة).

### int IMP_System_UnBind (IMPCell * srcCell ، IMPCell * dstCell)
فك تجميع المصادر والوجهات. 

### int IMP_System_GetBindbyDest (IMPCell * dstCell ، IMPCell * srcCell)

يسترجع المعلومات من الخلية المصدر المتعلقة بالوجهة.




